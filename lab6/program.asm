format ELF64                 ; Формат файла: ELF 64-bit

public _start                ; Точка входа программы

; Внешние функции из библиотеки ncurses
extrn initscr               ; Инициализация ncurses
extrn start_color           ; Включение поддержки цветов
extrn init_pair             ; Создание цветовой пары
extrn getmaxx               ; Получение максимальной X-координаты
extrn getmaxy               ; Получение максимальной Y-координаты
extrn raw                   ; Режим raw (сырой ввод)
extrn noecho                ; Отключение отображения ввода
extrn keypad                ; Включение обработки специальных клавиш
extrn stdscr                ; Указатель на стандартное окно
extrn move                  ; Перемещение курсора
extrn getch                 ; Получение символа с клавиатуры
extrn addch                 ; Добавление символа в текущую позицию
extrn refresh               ; Обновление экрана
extrn endwin                ; Завершение работы с ncurses
extrn exit                  ; Выход из программы
extrn timeout               ; Установка таймаута для ввода
extrn usleep                ; Задержка в микросекундах
extrn printw                ; Печать форматированной строки (не используется)

section '.bss' writable     ; Сегмент неинициализированных данных
    xmax dq 1               ; Максимальная X-координата (ширина)
    ymax dq 1               ; Максимальная Y-координата (высота)
    palette dq 1            ; Текущий цвет и символ для отрисовки
    delay dq ?              ; Задержка между кадрами (в микросекундах)

section '.text' executable  ; Сегмент исполняемого кода
_start:
    ; Инициализация ncurses
    call initscr            ; Вызов функции инициализации ncurses
    
    ; Получение размеров терминала
    mov rdi, [stdscr]       ; Загрузка указателя на стандартное окно
    call getmaxx            ; Получение максимальной X-координаты
    dec rax                 ; Уменьшение на 1 (индексация с 0)
    mov [xmax], rax         ; Сохранение в переменную xmax
    
    call getmaxy            ; Получение максимальной Y-координаты
    dec rax                 ; Уменьшение на 1
    mov [ymax], rax         ; Сохранение в переменную ymax
    
    ; Инициализация цветовой системы
    call start_color        ; Включение поддержки цветов
    
    ; Создание цветовых пар
    
    mov rdi, 1              ; Номер цветовой пары: 1
    mov rsi, 5              ; Цвет текст
    mov rdx, 5              ; Цвет фона
    call init_pair          ; Создание цветовой пары
    
    ; Цветовая пара 2: цвет 5 на черном
    mov rdi, 2              ; Номер цветовой пары: 2
    mov rsi, 1              ; 
    mov rdx, 0              ; Цвет фона: 0 (черный)
    call init_pair          ; Создание цветовой пары
    
    ; Обновление экрана для отображения изменений
    call refresh            ; Обновление экрана
    
    ; Настройка режимов ввода
    call noecho             ; Отключение эха (символы не отображаются при вводе)
    call raw                ; Включение raw режима (символы передаются сразу)
    
    ; Инициализация начального цвета и символа
    mov rax, ' '            ; Символ пробела
    or rax, 0x200           ; Установка атрибутов: 0x200 = цветовая пара 2
    mov [palette], rax      ; Сохранение в переменную palette

.begin:                     ; Начало основного цикла
    ; Переключение цвета между проходами
    mov rax, [palette]      ; Загрузка текущего значения палитры
    and rax, 0x100          ; Проверка младшего бита атрибута цвета
    cmp rax, 0              ; Сравнение с 0
    jne .mag                ; Если не ноль, перейти к .mag
    
    ; Установка цветовой пары 1 (0x100)
    mov rax, [palette]      ; Загрузка текущего значения палитры
    and rax, 0xff           ; Очистка атрибутов, оставляем только символ
    or rax, 0x100           ; Установка атрибута: 0x100 = цветовая пара 1
    jmp @f                  ; Переход к метке @@
    
.mag:                       ; Метка для установки цветовой пары 2
    ; Установка цветовой пары 2 (0x200)
    mov rax, [palette]      ; Загрузка текущего значения палитры
    and rax, 0xff           ; Очистка атрибутов, оставляем только символ
    or rax, 0x200           ; Установка атрибута: 0x200 = цветовая пара 2
    
@@:                         ; Локальная метка
    mov [palette], rax      ; Сохранение обновленного значения палитры
    
    ; Инициализация координат для нового прохода
    mov r8, [xmax]          ; Начальная X-координата = максимальная
    mov r9, 0               ; Начальная Y-координата = 0
    jmp .loop_to_left       ; Начало движения влево

.to_down_right:             ; Переход к следующей строке после движения влево
    dec r8                  ; X уменьшается (движение влево)
    inc r9                  ; Y увеличивается (движение вниз)
    cmp r9, [ymax]          ; Сравнение Y с максимальной высотой
    jg .begin               ; Если Y > ymax, начать новый проход
    ; Иначе продолжить движение

.loop_to_left:              ; Цикл движения влево
    ; Задержка для контроля скорости
    mov rdi, [delay]        ; Загрузка значения задержки
    call usleep             ; Вызов задержки в микросекундах
    
    ; Отрисовка символа в текущей позиции
    mov rdi, r9             ; Y-координата (строка)
    mov rsi, r8             ; X-координата (столбец)
    push r8                 ; Сохранение r8 (X) в стек
    push r9                 ; Сохранение r9 (Y) в стек
    call move               ; Перемещение курсора в позицию (Y, X)
    mov rdi, [palette]      ; Загрузка символа с атрибутами
    call addch              ; Отрисовка символа в текущей позиции
    call refresh            ; Обновление экрана
    
    ; Обработка ввода пользователя
    mov rdi, 1              ; Таймаут = 1 мс (неблокирующий ввод)
    call timeout            ; Установка таймаута
    call getch              ; Получение символа
    
    ; Проверка нажатых клавиш
    cmp rax, 'y'            ; Сравнение с 'y'
    jne @f                  ; Если не 'y', продолжить
    jmp .exit               ; Иначе выход из программы
    
@@:                         ; Локальная метка
    cmp rax, 'k'            ; Сравнение с 'k'
    jne @f                  ; Если не 'k', продолжить
    
    ; Изменение скорости
    cmp [delay], 1       ; Сравнение текущей задержки с 2000 мкс
    je .fast1               ; Если равна 2000, перейти к .fast1
    mov [delay], 1       ; Иначе установить задержку 2000 мкс (медленно)
    jmp @f                  ; Продолжить
    
.fast1:                     ; Метка для быстрой скорости
    mov [delay], 2000          ; Установить задержку 1 мкс (быстро)
    
@@:                         ; Локальная метка
    ; Восстановление регистров
    pop r9                  ; Восстановление r9 (Y)
    pop r8                  ; Восстановление r8 (X)
    
    ; Движение влево
    dec r8                  ; Уменьшение X (движение влево)
    cmp r8, 0               ; Сравнение X с 0
    jl .to_down_left        ; Если X < 0, перейти к следующей строке
    jmp .loop_to_left       ; Иначе продолжить движение влево

.to_down_left:              ; Переход к следующей строке после движения вправо
    inc r8                  ; X увеличивается (движение вправо)
    inc r9                  ; Y увеличивается (движение вниз)
    cmp r9, [ymax]          ; Сравнение Y с максимальной высотой
    jg .begin               ; Если Y > ymax, начать новый проход
    ; Иначе продолжить движение

.loop_to_right:             ; Цикл движения вправо
    ; Задержка для контроля скорости
    mov rdi, [delay]        ; Загрузка значения задержки
    call usleep             ; Вызов задержки в микросекундах
    
    ; Отрисовка символа в текущей позиции
    mov rdi, r9             ; Y-координата (строка)
    mov rsi, r8             ; X-координата (столбец)
    push r8                 ; Сохранение r8 (X) в стек
    push r9                 ; Сохранение r9 (Y) в стек
    call move               ; Перемещение курсора в позицию (Y, X)
    mov rdi, [palette]      ; Загрузка символа с атрибутами
    call addch              ; Отрисовка символа в текущей позиции
    call refresh            ; Обновление экрана
    
    ; Обработка ввода пользователя
    mov rdi, 1              ; Таймаут = 1 мс (неблокирующий ввод)
    call timeout            ; Установка таймаута
    call getch              ; Получение символа
    
    ; Проверка нажатых клавиш
    cmp rax, 'y'            ; Сравнение с 'z'
    jne @f                  ; Если не 'z', продолжить
    jmp .exit               ; Иначе выход из программы
    
@@:                         ; Локальная метка
    cmp rax, 'k'            ; Сравнение с 'g'
    jne @f                  ; Если не 'g', продолжить
    
    ; Изменение скорости
    cmp [delay], 1       ; Сравнение текущей задержки с 2000 мкс
    je .fast2               ; Если равна 2000, перейти к .fast2
    mov [delay], 1       ; Иначе установить задержку 2000 мкс (медленно)
    jmp @f                  ; Продолжить
    
.fast2:                     ; Метка для быстрой скорости
    mov [delay], 2000          ; Установить задержку 1 мкс (быстро)
    
@@:                         ; Локальная метка
    ; Восстановление регистров
    pop r9                  ; Восстановление r9 (Y)
    pop r8                  ; Восстановление r8 (X)
    
    ; Движение вправо
    inc r8                  ; Увеличение X (движение вправо)
    cmp r8, [xmax]          ; Сравнение X с максимальной шириной
    jg .to_down_right       ; Если X > xmax, перейти к следующей строке
    jmp .loop_to_right      ; Иначе продолжить движение вправо

.exit:                      ; Метка выхода из программы
    call endwin             ; Завершение работы с ncurses
    call exit               ; Выход из программы